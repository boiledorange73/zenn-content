---
title: "PostGISラスタの仕様"
---
# はじめに

PostGISが受け付けるジオメトリ表現については、[ジオメトリタイプ一覧をながめる](https://zenn.dev/boiledorange73/books/caea8d4c77dbba2e23a0/viewer/geomtypes)などでWKT/EWKTを、[WKB/EWKBを見てみる](https://zenn.dev/boiledorange73/books/caea8d4c77dbba2e23a0/viewer/inpect-ewkt)でWKB/EWKBを、それぞれ示しました。

PostGISが受け付けるラスタ表現は、EWKBのようなバイナリ(またはHEX文字列)になります。ここでは、PostGISラスタの仕様について解説します。

## 通常は必要が無い情報です

何をもって「通常」とするかで違ってくるかも知れませんが、PostGISに同梱されているraster2pgsqlで対応できない場合には必要な情報です。

逆に言うと、自前でコンバータを作るなら必要な情報です。

# PostGISラスタの書式

http://trac.osgeo.org/postgis/wiki/WKTRaster/Documentation01 (以下「ドキュメント」)の Table 2 を見てください。

* 1バイト - エンディアン (ビッグエンディアンは0x00, リトルエンディアンは0x01)
* 2バイト - (16ビット符号なし整数) バージョン (現在は0x0000)
* 2バイト - (16ビット符号なし整数) バンド数
* 8バイト - (64ビット浮動小数点数) 横方向セルひとつの地図上での大きさ
* 8バイト - (64ビット浮動小数点数) 縦方向セルひとつの地図上での大きさ
* 8バイト - (64ビット浮動小数点数) 左上隅の地図上のX座標値
* 8バイト - (64ビット浮動小数点数) 左上隅の地図上のY座標値
* 8バイト - (64ビット浮動小数点数) スキュー
* 8バイト - (64ビット浮動小数点数) スキュー
* 4バイト - (32ビット整数) 空間参照系ID (指定しない場合は 0)
* 2バイト - (16ビット符号なし整数) 横方向セル数
* 2バイト - (16ビット符号なし整数) 縦方向セル数

つづいて、バンドごとに次のデータが付きます。

* 1バイト - バンドタイプ
* NODATA値 (NODATA値の有無にかかわらず)
* セルごとの値 (非圧縮)

バンドタイプは、MSB側、LSB側4ビットに分けて考えた方が良いかと思います。

MSB側4ビットは、MSB側から見て、次のようになります。

* HEXEWKBにデータを含めるなら0、外部データなら1
* NODATA値を持つなら1、持たないなら0
* 0
* 0

LSB側4ビットで次に示す数値型が入ります。

* 0x0 1BB (1ビット)
* 0x1 2BUI (2ビット符号なし整数)
* 0x2 4BUI (4ビット符号なし整数)
* 0x3 8BSI (8ビット符号あり整数)
* 0x4 8BUI (8ビット符号なし整数)
* 0x5 16BSI (16ビット符号あり整数)
* 0x6 16BUI (16ビット符号なし整数)
* 0x7 32BSI (32ビット符号あり整数)
* 0x8 32BUI (32ビット符号なし整数)
* 0x9 (なし)
* 0xA 32BF (32ビット浮動小数点数)
* 0xB 64BF (64ビット浮動小数点数)

このリストは、PostGISのソース raster/rt_core/rt_api.h で確認できます。

以上を踏まえて、例を示します。

NODATA値を持つ'32BF'型の場合は 0x4A となり、NODATA値を持たない場合は 0x0A となります。

## データサイズ

上の説明でもってサイズは容易に算出できますが、確認のために、サイズを次に示します。

* ヘッダ 61 [バイト]
* バンド 1+(1+横ピクセル数×縦ピクセル数)×値サイズ [バイト]

## 左上隅の座標値が指す位置について

ヘッダ部で出てくる、左上隅の座標値については若干注意しなければなりません。

PostGISラスタの「ドキュメント」によると、ワールドファイルのCパラメータ、Fパラメータに対応する旨記載があります。

ワールドファイルの書式に従うと、左上隅セルの*中心*の位置とするべきだと考えることでしょう。しかし、PostGISラスタは、そうではなく、左上隅セルの*左上隅*の位置を記述します。

![左上隅位置の違い](https://github.com/boiledorange73/zenn-content/blob/main/books-images/pgis-raster-beginner/pgisraster/1.png?raw=true)

## スキュー

スキューについてややこしいと感じるようでしたら、[ワールドファイルのはなし](worldfile) に掲げられている図などを見てみて下さい。

# おわりに

ラスタファイルの簡単な説明と、PostGISラスタの書式について説明しました。ピクセル数や地理参照情報はラスタごとに固定されますが、数値型やNoData値はバンドごとに設定されます。また、圧縮が仕様に含まれていないので、データサイズが大きくなるのは覚悟しなければなりません。

PostGIS には raster2pgsql が同梱されているので、普通の使い方をしている場合は、PostGISラスタの仕様を学習する必要はありません。このコンバータに何らかの不満があったり、対応していない書式のラスタデータからコンバートしなければならない場合に限られます。
