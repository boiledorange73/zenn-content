---
title: "トポロジーの内側をちょっと覗いちゃおう!"
---

# はじめに

ここでは、``node``, ``edge_data``, ``face`` テーブルを見ていきます。

はっきり言って、これを見ることができてもできなくても、トポロジーやトポジオメトリーを使うことができます。お急ぎなら、ざっと見るだけでいいと思います。

ただ、より深く理解するためには、ある程度知っていてもいいかとも思います。

# テーブルを見て行きましょう

次のような構成のトポロジーを構築しているとします。

![トポロジー図](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/inside/all.png)

この時の ``node``, ``edge_data``, ``face`` テーブルを見ていきましょう。

まず ``node`` です。``node.geom`` は、ノードの位置を示すポイントデータです。

```
SELECT * FROM topo0.node ORDER BY node_id;
 node_id | containing_face |                    geom                    
---------+-----------------+--------------------------------------------
       1 |                 | 010100000000000000000000000000000000000000
       2 |                 | 010100000000000000000024400000000000000000
       3 |                 | 010100000000000000000024400000000000002440
(3 rows)
```

続いて、かなり重要になる ``edge_data`` です。見るだけにしておきます。

```
SELECT * FROM topo0.edge_data ORDER BY edge_id;
 edge_id | start_node | end_node | next_left_edge | abs_next_left_edge | next_right_edge | abs_next_right_edge | left_face | right_face |                                                                        geom                                                                        
---------+------------+----------+----------------+--------------------+-----------------+---------------------+-----------+------------+----------------------------------------------------------------------------------------------------------------------------------------------------
       1 |          1 |        2 |              2 |                  2 |              -3 |                   3 |         1 |          0 | 0102000000020000000000000000000000000000000000000000000000000024400000000000000000
       2 |          2 |        3 |              3 |                  3 |               4 |                   4 |         1 |          2 | 010200000003000000000000000000244000000000000000000000000000002E40000000000000144000000000000024400000000000002440
       3 |          3 |        1 |              1 |                  1 |              -4 |                   4 |         1 |          0 | 010200000003000000000000000000244000000000000024400000000000000000000000000000244000000000000000000000000000000000
       4 |          2 |        3 |             -2 |                  2 |              -1 |                   1 |         2 |          0 | 01020000000400000000000000000024400000000000000000000000000000344000000000000000000000000000003440000000000000244000000000000024400000000000002440
(4 rows)

```

そして ``face`` です。こちらはジオメトリーカラム名が ``mbr`` になっていることに注意してください。フェイスを正確に表現するポリゴンは納められていません。

```
SELECT * FROM topo0.face ORDER BY face_id;
 face_id |                                                                                            mbr                                                                                             
---------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
       0 | 
       1 | 0103000000010000000500000000000000000000000000000000000000000000000000000000000000000024400000000000002E4000000000000024400000000000002E40000000000000000000000000000000000000000000000000
       2 | 010300000001000000050000000000000000002440000000000000000000000000000024400000000000002440000000000000344000000000000024400000000000003440000000000000000000000000000024400000000000000000
(3 rows)
```

あと ``edge`` というのもありますが、これは SQL/MM互換のために ``edge_data`` から一部のカラムを抜いたビューです。

```
SELECT * FROM topo0.edge ORDER BY edge_id;
 edge_id | start_node | end_node | next_left_edge | next_right_edge | left_face | right_face |                                                                        geom                                                                        
---------+------------+----------+----------------+-----------------+-----------+------------+----------------------------------------------------------------------------------------------------------------------------------------------------
       1 |          1 |        2 |              2 |              -3 |         1 |          0 | 0102000000020000000000000000000000000000000000000000000000000024400000000000000000
       2 |          2 |        3 |              3 |               4 |         1 |          2 | 010200000003000000000000000000244000000000000000000000000000002E40000000000000144000000000000024400000000000002440
       3 |          3 |        1 |              1 |              -4 |         1 |          0 | 010200000003000000000000000000244000000000000024400000000000000000000000000000244000000000000000000000000000000000
       4 |          2 |        3 |             -2 |              -1 |         2 |          0 | 01020000000400000000000000000024400000000000000000000000000000344000000000000000000000000000003440000000000000244000000000000024400000000000002440
(4 rows)
```

# edge_data を見る

``node``と``face``はおそらく見れば分かるというか、識別番号とジオメトリーとの組み合わせでしかありません。トポロジーの中核は ``edge_data`` にあります。ここで``edge_data``を見てみましょう。

|edge_id | start_node | end_node | next_left_edge | next_right_edge | left_face | right_face |
|--------|------------|----------|----------------|-----------------|-----------|------------|
|      1 |          1 |        2 |              2 |              -3 |         1 |          0 | 
|      2 |          2 |        3 |              3 |               4 |         1 |          2 | 
|      3 |          3 |        1 |              1 |              -4 |         1 |          0 | 
|      4 |          2 |        3 |             -2 |              -1 |         2 |          0 | 

上の表と下の図の赤字の四角形の数字とが対応しています。

![トポロジー図](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/inside/all.png)

## 2番エッジの左右のフェイスを見る

2番エッジの``left_face``と``right_face``に注目します。

|edge_id | start_node | end_node | next_left_edge | next_right_edge | left_face | right_face |
|--------|------------|----------|----------------|-----------------|-----------|------------|
|  **2** |          2 |        3 |              3 |               4 |     **1** |      **2** | 

これは、進行方向（始端から終端に向かう方向）で見て**左側に1番フェイス**があり、**右側に2番フェイス**があることを示しています。

確認してみましょう。

![2番エッジを強調したトポロジー図](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/inside/edge2.png)

## 1番フェイスを1周する

次の図から、何番エッジをたどって行けば1番フェイスを1周できるかは分かると思います。

![1番フェイスを強調したトポロジー図](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/inside/edges_face1.png)

``edge_data``テーブルでたどれるかどうかを確認していきます。

``next_left_edge``は、``left_face``を構成するエッジをたどる場合に、次にたどるエッジ識別番号が格納されています。

|edge_id | start_node | end_node | next_left_edge | next_right_edge | left_face | right_face |
|--------|------------|----------|----------------|-----------------|-----------|------------|
|  **2** |          2 |        3 |          **3** |               4 |     **1** |          2 | 
|  **3** |          3 |        1 |              1 |              -4 |         1 |          0 | 

これで見ると、次は、**3番エッジをたどります**。

|edge_id | start_node | end_node | next_left_edge | next_right_edge | left_face | right_face |
|--------|------------|----------|----------------|-----------------|-----------|------------|
|  **1** |          1 |        2 |              2 |              -3 |         1 |          0 | 
|      2 |          2 |        3 |              3 |               4 |     **1** |          2 | 
|  **3** |          3 |        1 |          **1** |              -4 |         1 |          0 | 

さらに、**1番エッジをたどる**ことになります。そして最後に、**2番エッジ**をたどることになり、1周しました。

つまり、2番エッジ→3番エッジ→1番エッジ で1番フェイスが形成されています。

## 2番フェイスを1周する

では、次の図に示す2番フェイスをたどってみましょう。

![2番フェイスを強調したトポロジー図](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/inside/edges_face2.png)

2番エッジから始めます。``right_face``が``2``です。``next_right_edge``が``4``ですので4番エッジをたどります。

|edge_id | start_node | end_node | next_left_edge | next_right_edge | left_face | right_face |
|--------|------------|----------|----------------|-----------------|-----------|------------|
|  **2** |          2 |        3 |              3 |           **4** |         1 |      **2** | 

ここで気を付けてください。右側をたどる場合には、たどる前のエッジを**逆方向に見る**必要があります。ここではたどる前のエッジは2番エッジで、2番ノードから3番ノードに向かうのが順方向です。これを逆方向に見ると終端は2番ノードになります。

そして図を改めてみると、2番ノードを始点とする場合には、4番エッジは順方向になります。よって``next_right_edge``はマイナスになりません。

次に4番エッジを見ます。

|edge_id | start_node | end_node | next_left_edge | next_right_edge | left_face | right_face |
|--------|------------|----------|----------------|-----------------|-----------|------------|
|  **2** |          2 |        3 |              3 |               4 |         1 |          2 | 
|  **4** |          2 |        3 |         **-2** |              -1 |     **2** |          0 | 

4番エッジを順方向に見ると、まず、フェイスは左側を見ます。2番フェイスですね。次にたどるエッジを見ます。4番エッジ順方向の終端は3番ノードで、これは2番エッジの終端です。よって2番エッジは逆方向にたどることになります。よって ``next_left_edge`` は ``-2`` となります。そして、順方向でも逆方向でも2番エッジに戻ったので終了します。

以上から、2番エッジ(逆方向)→2番エッジ(順方向) で2番フェイスが形成されることが分かります。

## おわりに

``node``, ``faace`` があることを紹介したうえで、``edge_data``の見方を紹介しました。

ユーザーは通常、これらのテーブルは見ません。ただ、こういう雰囲気でデータが格納、管理されていることを知っていただいたら、トポロジー機能を使う際に、裏でこういうデータがあるんだというのが分った方が、問題解決能力が上がると思います。
