---
title: "トポジオメトリーでトポロジー操作なんか忘れちゃおう！"
---

# トポジオメトリーとは

![トポジオメトリーの概要](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/topogeo/whatistopogeo.png)

トポジオメトリーは、テーブルにカラムとして持たせられるもので、このカラムのデータは、ノード、エッジ、フェイスを識別する情報の集合で、たとえばマルチのフェイスなどの図形を形成できるだけの情報が収められています。

トポジオメトリーカラムの他には文字列型カラムや整数型カラムなど、好きな型のカラムを追加することができます。

## プリミティブ

トポジオメトリーに参照されるノード、エッジ、フェイスを総称して 「**プリミティブ**」と呼びます (レイヤーでよく使われます)。

# トポジオメトリーを作っちゃおう!

次のような2市からなる地図を作ります。

![完成図](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/topogeo/sample1.png)

ただし、ノードを打ったりエッジを引いたりせずに「左下市」「右下市」を作ります。

なお、これは「レイヤー構造を使っちゃおう!」でも使います。

## 準備

下準備としてトポロジーを新規に作ります。

```
SELECT topology.CreateTopology('topo1');
```

トポジオメトリーカラムを除いたカラム構成のテーブルを生成します。

```
CREATE TABLE mncpl (
    gid SERIAL PRIMARY KEY,
    mid INT UNIQUE,
    name TEXT
);
```

そして、ジオメトリーカラムを追加します。[AddTopoGeometryColumn()](https://postgis.net/docs/ja/AddTopoGeometryColumn.html)を使います。

```
SELECT topology.AddTopoGeometryColumn('topo1', 'public', 'mncpl', 'topogeo', 'POLYGON');

 addtopogeometrycolumn 
-----------------------
                     1
(1 row)

```

``AddTopoGeometryColumn``の返り値は「レイヤーID」といいます。「レイヤー」?そうです、**トポジオメトリーカラムとレイヤーとは同じもの**です。

なお、**トポジオメトリーカラムには空間インデックスを生成することができません**。

## ジオメトリーからトポジオメトリーへの変換

次のクエリを実行してみてください。

```
INSERT INTO mncpl(mid,name, topogeo)
SELECT 1001, '左下市', topology.toTopoGeom(
  'POLYGON((0 0, 10 0, 15 5, 10 10, 0 10, 0 0))', 'topo1', 1
);

INSERT INTO mncpl(mid, name, topogeo)
SELECT 1002, '右下市', topology.toTopoGeom(
  'POLYGON((10 0, 15 5, 10 10, 20 10, 20 0, 10 0))', 'topo1', 1
);
```

ジオメトリーを挿入しています。**これでちゃんとトポジオメトリーデータが入る**んです。``node``, ``edge_data``, ``face``にトポロジーデータが格納されてるんです。

## トポジオメトリーからジオメトリーへの変換

トポジオメトリーからジオメトリーに変換するのはキャストでOKです。

```
SELECT name, ST_AsEWKT(topogeo::GEOMETRY) FROM mncpl WHERE mid=1001;

 name  |                    st_asewkt                    
--------+-------------------------------------------------
 左下市 | MULTIPOLYGON(((10 0,0 0,0 10,10 10,15 5,10 0)))
```

## トポジオメトリーをQGISで見てみる

![QGISで見た完成図](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/topogeo/mncpl.png)

# 各テーブルを見てみよう

## QGISでトポロジーを見る

トポロジーとして形状データが入っていることを QGIS で確認しましょう。

![QGISで見た完成図](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/topogeo/primitives.png)

## ノード、エッジ、フェイスを見る

QGIS で見てるので、ここは正直**どうでもいい**ですが、いちおう見ておきましょう。

```
SELECT * FROM topo1.node ORDER BY node_id;

node_id | containing_face |                    geom                    
---------+-----------------+--------------------------------------------
       1 |                 | 010100000000000000000000000000000000000000
       2 |                 | 010100000000000000000024400000000000002440
       3 |                 | 010100000000000000000024400000000000000000
(3 rows)
```

```
SELECT * FROM topo1.edge_data ORDER BY edge_id;

 edge_id | start_node | end_node | next_left_edge | abs_next_left_edge | next_right_edge | abs_next_right_edge | left_face | right_face |                                                                        geom                                                                        
---------+------------+----------+----------------+--------------------+-----------------+---------------------+-----------+------------+----------------------------------------------------------------------------------------------------------------------------------------------------
       1 |          1 |        3 |              3 |                  3 |              -2 |                   2 |         1 |          0 | 0102000000020000000000000000000000000000000000000000000000000024400000000000000000
       2 |          2 |        1 |              1 |                  1 |               4 |                   4 |         1 |          0 | 010200000003000000000000000000244000000000000024400000000000000000000000000000244000000000000000000000000000000000
       3 |          3 |        2 |              2 |                  2 |              -4 |                   4 |         1 |          2 | 010200000003000000000000000000244000000000000000000000000000002E40000000000000144000000000000024400000000000002440
       4 |          2 |        3 |             -1 |                  1 |              -3 |                   3 |         0 |          2 | 01020000000400000000000000000024400000000000002440000000000000344000000000000024400000000000003440000000000000000000000000000024400000000000000000
(4 rows)
```

```
SELECT * FROM topo1.face ORDER BY face_id;

 face_id |                                                                                            mbr                                                                                             
---------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
       0 |
       1 | 0103000000010000000500000000000000000000000000000000000000000000000000000000000000000024400000000000002E4000000000000024400000000000002E40000000000000000000000000000000000000000000000000
       2 | 010300000001000000050000000000000000002440000000000000000000000000000024400000000000002440000000000000344000000000000024400000000000003440000000000000000000000000000024400000000000000000
(3 rows)
```

## relation を見る

``relation``というテーブルがトポロジースキーマ (ここでは``topo1``) にあります。ここまで空っぽだったので見てこなかったのですが、とうとう見る時が来ました。

```
SELECT * FROM topo1.relation;

 topogeo_id | layer_id | element_id | element_type 
------------+----------+------------+--------------
          1 |        1 |          1 |            3
          2 |        1 |          2 |            3
(2 rows)
```

- ``topogeo_id`` - トポジオメトリーの識別番号です。レイヤーごとに番号が振られます。
- ``layer_id`` - トポジオメトリーカラム = レイヤーの識別番号を示しています。いまのところ 1番レイヤー の一つだけです。
- ``element_id`` - ノードID、エッジID、フェイスIDのいずれかです。``element_type``が``3``の場合は、フェイスIDです。
- ``element_type` - - 1-ノード、2-エッジ、3-フェイスを示します (階層構造がある場合は別)

ここで、トポジオメトリーとノード、エッジ、フェイスとをつないでいます。

## TopoGeometryの中身

最後に、トポジオメトリー型データを見てみましょう。

```
SELECT * FROM mncpl ORDER BY gid;

 gid | mid  |  name  |  topogeo  
-----+------+--------+-----------
   1 | 1001 | 左下市 | (2,1,1,3)
   2 | 1002 | 右下市 | (2,1,2,3)
(2 rows)
```

``TopoGeometry``型は4個のプロパティがある複合型です (https://postgis.net/docs/manual-dev/ja/topogeometry.html)。

- ``topology_id`` - トポロジーの識別番号です。ここでは ``topo1`` を指す番号です。
- ``layer_id`` - レイヤー=トポジオメトリーカラムの識別番号です。``AddTopoGeometryColumn``の返り値でもあります。
- ``id`` - トポジオメトリー識別番号です。
- ``type`` - 1-ノード、2-エッジ、3-フェイスを示します (階層構造がある場合は別)

これは ``relation`` と、順番やプロパティ/カラム名が違いますが、同じようなデータ構造です。

# おわりに

トポジオメトリーを使うと属性データが扱えて、ジオメトリーからトポジオメトリーに変換するのは ``toTopoGeom`` を使うだけで済み、ほとんどトポロジーのノード、エッジ、フェイスのことは考えなくて済むようになります。

というか、本当は直接ノード、エッジ、フェイスは扱わないんじゃないかなと思います。
