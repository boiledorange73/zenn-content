---
title: "トポロジをいじってみよう"
---

# はじめに

ちょっとトポロジをいじってみて、どういう動きをするのか見てみましょう。

たぶん、トポジオメトリを多用することになると思いますが、その場合には、ここでの説明はほぼ役に立ちません。

# 準備

## データベースがあるものとします

topologydbという名前のデータベースがあり、PostGIS、PostGISトポロジが導入されているとします。まだ作っていないなら、[そもそもトポロジとは何やねん](whatistopology)を参考に作って下さい。

# 新しいトポロジを用意する

まず、新しいトポロジを用意します。

```
topologydb=# SELECT topology.CreateTopology('topo1', 3857, 0.1);
 createtopology
----------------
              1
(1 行)
```

これでトポロジが準備できました。

現在の``topo1``トポロジの状況を見てみます。

```
topologydb=# SELECT topology.TopologySummary('topo1');
                  topologysummary
----------------------------------------------------
 Topology topo1 (id 1, SRID 3857, precision 0.1)   +
 0 nodes, 0 edges, 0 faces, 0 topogeoms in 0 layers+

(1 行)
```

レイヤがありませんし、その中にはノードもエッジもフェイスもトポジオメトリもありません、と言っています。

# 初期のテーブル構成

```
topologydb=# SELECT * FROM pg_tables WHERE schemaname='topo1';
 schemaname | tablename | tableowner | tablespace | hasindexes | hasrules | hastriggers | rowsecurity
------------+-----------+------------+------------+------------+----------+-------------+-------------
 topo1      | face      | postgres   |            | t          | f        | t           | f
 topo1      | node      | postgres   |            | t          | f        | t           | f
 topo1      | edge_data | postgres   |            | t          | f        | t           | f
 topo1      | relation  | postgres   |            | t          | f        | t           | f
(4 行)
```

ほぼ空っぽですが、フェイスに１件存在します。

```
topologydb=# SELECT * FROM topo1.face;
 face_id | mbr
---------+-----
       0 |
(1 行)
```

これは、ユニバースフェイスと呼ばれる、無限の広さを持つフェイスです。

# さっそくやってみよう

## 孤立ノードの追加

```
topologydb=# SELECT topology.ST_AddIsoNode(
  'topo1',
  0,
  'SRID=3857;POINT(15540700 4254000)'
);

 st_addisonode
---------------
             1
(1 行)
```

返り値は、作成されたノードのノードIDです。覚えておいて下さい。

この時点でのノードの格納状況は次のようになっています。

```
topologydb=# SELECT * FROM topo1.node;
 node_id | containing_face |                        geom
---------+-----------------+----------------------------------------------------
       1 |               0 | 0101000020110F0000000000803BA46D41000000004C3A5041
(1 行)
```

QGISで見ると次のようになっています。

![1ノードを追加した様子](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/editing/1.png)


同じように、二つ孤立ノードを追加します。

```
topologydb=# SELECT topology.ST_AddIsoNode(
  'topo1',
  0,
  'SRID=3857;POINT(15541700 4254000)'
);

 st_addisonode
---------------
             2
(1 行)
```

```
topologydb=# SELECT topology.ST_AddIsoNode(
  'topo1',
  0,
  'SRID=3857;POINT(15540700 4253000)'
);

 st_addisonode
---------------
             3
(1 行)
```

ノードの格納状況を確認すると、次のようになっていました。

```
topologydb=# select * from topo1.node;
 node_id | containing_face |                        geom
---------+-----------------+----------------------------------------------------
       1 |                 | 0101000020110F0000000000803BA46D41000000004C3A5041
       2 |                 | 0101000020110F000000000080B8A46D41000000004C3A5041
       3 |                 | 0101000020110F0000000000803BA46D410000000052395041
(3 行)
```

QGISで見ると次のようになっています。

![3ノードを追加した様子](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/editing/2.png)

## 孤立ノードをつなぐエッジを作る

```
topologydb=# SELECT topology.ST_AddEdgeModFace(
  'topo1',
  1, 2,
  'SRID=3857;LINESTRING(15540700 4254000, 15541700 4254000)'
);

 st_addedgemodface
-------------------
                 1
(1 行)
```

```
topologydb=# SELECT * FROM topo1.node;
 node_id | containing_face |                        geom
---------+-----------------+----------------------------------------------------
       3 |               0 | 0101000020110F0000000000803BA46D410000000052395041
       1 |                 | 0101000020110F0000000000803BA46D41000000004C3A5041
       2 |                 | 0101000020110F000000000080B8A46D41000000004C3A5041
(3 行)


topologydb=# SELECT * FROM topo1.edge_data;
 edge_id | start_node | end_node | next_left_edge | abs_next_left_edge | next_right_edge | abs_next_right_edge | left_face | right_face |                                            geom
---------+------------+----------+----------------+--------------------+-----------------+---------------------+-----------+------------+--------------------------------------------------------------------------------------------
       1 |          1 |        2 |             -1 |                  1 |               1 |                   1 |         0 |          0 | 0102000020110F000002000000000000803BA46D41000000004C3A504100000080B8A46D41000000004C3A5041
(1 行)
```

エッジデータが追加されています。
1番ノードから2番ノードに向かうエッジで、左側のフェイスも右側のフェイスもユニバースフェイスです。

QGISで見ると次のようになっています。

![1エッジを追加した様子](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/editing/3.png)


同様に1番ノードから3番ノードにも作ります。

```
topologydb=# SELECT topology.ST_AddEdgeModFace(
  'topo1',
  1, 3,
  'SRID=3857;LINESTRING(15540700 4254000, 15540700 4253000)'
);

 st_addedgemodface
-------------------
                 2
(1 行)
```

```
topologydb=# SELECT * FROM topo1.node;
 node_id | containing_face |                        geom
---------+-----------------+----------------------------------------------------
       1 |                 | 0101000020110F0000000000803BA46D41000000004C3A5041
       2 |                 | 0101000020110F000000000080B8A46D41000000004C3A5041
       3 |                 | 0101000020110F0000000000803BA46D410000000052395041
(3 行)


topologydb=# SELECT * FROM topo1.edge_data;
 edge_id | start_node | end_node | next_left_edge | abs_next_left_edge | next_right_edge | abs_next_right_edge | left_face | right_face |                                            geom
---------+------------+----------+----------------+--------------------+-----------------+---------------------+-----------+------------+--------------------------------------------------------------------------------------------
       2 |          1 |        3 |             -2 |                  2 |               1 |                   1 |         0 |          0 | 0102000020110F000002000000000000803BA46D41000000004C3A5041000000803BA46D410000000052395041
       1 |          1 |        2 |             -1 |                  1 |               2 |                   2 |         0 |          0 | 0102000020110F000002000000000000803BA46D41000000004C3A504100000080B8A46D41000000004C3A5041
(2 行)
```

QGISで見ると次のようになっています。

![2エッジを追加した様子](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/editing/4.png)

## 三つ目のエッジで四角形フェイスを作る

```
topologydb=# SELECT topology.ST_AddEdgeModFace(
  'topo1',
  3, 2,
  'SRID=3857;LINESTRING(15540700 4253000, 15541700 4253000, 15541700 4254000)'
);

 st_addedgemodface
-------------------
                 3
(1 行)
```

```
topologydb=# SELECT * FROM topo1.face;
 face_id |                                                                                                mbr           
---------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
       0 |
       1 | 0103000020110F00000100000005000000000000803BA46D410000000052395041000000803BA46D41000000004C3A504100000080B8A46D41000000004C3A504100000080B8A46D410000000052395041000000803BA46D410000000052395041
(2 行)
```

フェイスが一つ追加されました。

```
topologydb=# SELECT * FROM topo1.edge_data;
 edge_id | start_node | end_node | next_left_edge | abs_next_left_edge | next_right_edge | abs_next_right_edge | left_face | right_face |                                                            geom                                       
---------+------------+----------+----------------+--------------------+-----------------+---------------------+-----------+------------+----------------------------------------------------------------------------------------------------------------------------
       2 |          1 |        3 |              3 |                  3 |               1 |                   1 |         1 |          0 | 0102000020110F000002000000000000803BA46D41000000004C3A5041000000803BA46D410000000052395041
       3 |          3 |        2 |             -1 |                  1 |              -2 |                   2 |         1 |          0 | 0102000020110F000003000000000000803BA46D41000000005239504100000080B8A46D41000000005239504100000080B8A46D41000000004C3A5041
       1 |          1 |        2 |             -3 |                  3 |               2 |                   2 |         0 |          1 | 0102000020110F000002000000000000803BA46D41000000004C3A504100000080B8A46D41000000004C3A5041
(3 行)
```

エッジが一つ追加されています。
1番エッジは左がユニバースフェイス、右が1番フェイスになっています。
また、最も左のエッジは3番エッジ（逆向き）で、最も右側のエッジは2番エッジです。

QGISで見ると次のようになっています。

![3エッジを追加した様子](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/editing/5.png)

ここで分かりにくいのですが、3番エッジは、3番ノードから2番ノードに向かっているのですが、2辺からなっています。

# エッジテーブルをもう少ししっかり見る

エッジテーブルを、今度はもう少ししっかり見てみます。

``start_node``と``end_node``は、エッジの開始ノードと終了ノードです。

``left_face``と``right_face``は、開始ノードから終了ノードに向かって見て、それぞれ左側のフェイスと右側のフェイスです。

``next_left_edge``は、``left_face``の境界を構成するエッジの、終了ノードで接続するエッジです。負の数の場合には、自エッジと逆方向になります。``next_right_edge``も``right_face``の境界を構成するエッジの、終了ノードで接続するエッジです。

``abs_next_left_edge``と``abs_next_right_edge``は、それぞれ、``next_left_edge``と``next_right_edge``の値の符号を取り除いたものです。

``geom``は、ジオメトリです。いらないと思うかもしれませんが、``start_node``から``end_node``まで直線であるわけでもない(この例での3番エッジは、2辺からなっていますね)ので、ジオメトリ (ラインストリング)データは必要になります。

## next_*_edge 以外の情報を見る

まずは、``edge_id``, ``start_node``, ``end_node``, ``left_face``, ``right_face``だけを見ます。

```
topologydb=# SELECT edge_id, start_node, end_node, left_face, right_face FROM topo1.edge_data ORDER BY edge_id;
 edge_id | start_node | end_node | left_face | right_face
---------+------------+----------+-----------+------------
       1 |          1 |        2 |         0 |          1
       2 |          1 |        3 |         1 |          0
       3 |          3 |        2 |         1 |          0
(3 行)
```

1行目に注目して下さい。1番エッジ (edge_id=1)ですが、``start_node``と``end_node``から、このエッジは、1番ノードから2番ノードに向かうエッジであることが分かります。さらに、``left_face``から、このエッジの順方向から見て左側にユニバースフェイス(face_id=0のフェイス)がり、``right_face``から、右側には1番フェイスがあることが分かります。
同じく、2番エッジは1番ノードから3番ノードに向かい、左側に1番フェイス、右側にユニバースフェイスがあります。また、3番エッジは、3番ノードから2番ノードに向かい、左側に1番フェイス、右側にユニバースフェイスがあります。

## next_*_edge を見る

``next_left_edge``と``next_right_edge``を見てみます。追加で``left_face``と``right_face``も併せて見てみます。

```
topologydb=# SELECT edge_id, left_face, right_face, next_left_edge, next_right_edge FROM topo1.edge_data ORDER BY edge_id;
 edge_id | left_face | right_face | next_left_edge | next_right_edge
---------+-----------+------------+----------------+-----------------
       1 |         0 |          1 |             -3 |               2
       2 |         1 |          0 |              3 |               1
       3 |         1 |          0 |             -1 |              -2
(3 行)
```

今度は、都合のため、最初に2番エッジを見て下さい。1番エッジは最後に見ます。

2番エッジは、左側に1番フェイスがあるのは先ほど申しましたが、このことから、2番エッジは、「左側に1番フェイスを見る境界」を形成するエッジ列の一つであることが言えます。

「左側に1番フェイスを見る境界」とはまた長ったらしい名前ですが、エッジ列の順番通りに見ていくと、常に進行方向左側に1番フェイスを見るような境界となるエッジ列を指しています。

左側に同一フェイス(ここでは1番フェイス)を見る境界を形成するエッジ列の、次のエッジを示すのが``next_left_edge``です。2番エッジの``next_left_edge``が3なので、左側に1番フェイスを見る境界を形成するエッジ列のうち、2番エッジの次は3番エッジです。エッジ列のどこに2番エッジが出現するかは決まっていませんが、2番エッジの次は3番エッジ、という相対的な順番は決まっています。

ここで、せっかくなので、左側に1番フェイスを見る境界を形成するエッジ列を辿ってみましょう。
2番エッジの次の3番エッジを見てみましょう。2番エッジと同じで、1番フェイスは、3番エッジの左側にあります。3番エッジの次は、``-1``となっています。これは、１番フェイスの境界としては、3番エッジから1番エッジにつながっているけれども、逆方向 (終了ノードから開始ノードに向かう)になっていることを示します。
1番エッジを見ると、さきほど言及した通り逆になっているので、右側に1番フェイスが現れます。なので次のエッジを見るには、``next_right_edge``を見ます。``next_right_edge``は``2``となっているので、2番エッジにつながり、これで境界エッジ列が閉じました。

まとめると、2番エッジ、3番エッジ、1番エッジ(逆方向)の順で、左側に1番フェイスを見る境界が形成されるのが分かります。

同じように、1番エッジの左側のユニバースフェイスを追いかけていくと、1番エッジ、3番エッジ(逆方向)、2番エッジ(逆方向)の順で左側にユニバーサルエッジを見る境界エッジ列が得られます。

## ノードの順番を見る

最後に、蛇足気味ですが、ノードの順番を見てみましょう。

```
topologydb=# SELECT edge_id, start_node, end_node, left_face, right_face, next_left_edge, next_right_edge FROM topo1.edge_data ORDER BY edge_id;
 edge_id | start_node | end_node | left_face | right_face | next_left_edge | next_right_edge
---------+------------+----------+-----------+------------+----------------+-----------------
       1 |          1 |        2 |         0 |          1 |             -3 |               2
       2 |          1 |        3 |         1 |          0 |              3 |               1
       3 |          3 |        2 |         1 |          0 |             -1 |              -2
(3 行)
```

左側に1番フェイスを見る境界は、エッジ列では、2番エッジ、3番エッジ、1番エッジ(逆方向)の順になっていますが、これをノード番号に変えてみます。2番エッジは1番ノードから3番ノード、3番エッジは3番ノードから2番ノード、1番エッジ(逆方向)は``start_node``と``end_node``をひっくり返して、2番ノードから1番ノード、となります。

まとめると、1番ノード、3番ノード、2番ノード、1番ノードの順になります。上の図で、この順番で行くと、常に1番フェイス(真ん中の四角形)は進行方向左側にあることが分かって頂けると思います。

# おわりに

以上の通り、エッジとノード、エッジとフェイスがかかわりあっているのがお分かりいただけたと思います。特にエッジがややこしくなっています。

完全には理解する必要はありませんが、PostGISトポロジを理解するのには必要な情報だろうと思いますので、さっと見ていって下さい。

# 出典

QGISの背景図に[歴史的農業環境閲覧システム](https://habs.dc.affrc.go.jp/)が提供する関東平野迅速測図を使用しました、思い付きで。


