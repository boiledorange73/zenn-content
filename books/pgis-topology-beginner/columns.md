---
title: "トポロジテーブルをもう少し見てみよう"
---

# はじめに

[トポロジをいじってみよう](editing)では、四角形フェイスを作るところまでをご覧頂きました。その際に、ノード、エッジ、フェイスの各テーブルの中身を示していましたが、大した説明をしていませんでした。今回は、テーブルの中身について、もう少し詳しく見ていきたいと思います。

[トポロジをいじってみよう](editing)で、三つのエッジを追加した直後のテーブルを見ていきます。次にその時の画像を示します。

![3エッジを追加した様子](https://raw.githubusercontent.com/boiledorange73/zenn-content/main/books-images/pgis-topology-beginner/editing/5.png)


# ノード

```
topologydb=# SELECT * FROM topo1.node ORDER BY node_id;
 node_id | containing_face |                        geom
---------+-----------------+----------------------------------------------------
       1 |                 | 0101000020110F0000000000803BA46D41000000004C3A5041
       2 |                 | 0101000020110F000000000080B8A46D41000000004C3A5041
       3 |                 | 0101000020110F0000000000803BA46D410000000052395041
(3 行)
```

``geom``は、ノードに対応するポイントです。

なお、``containing_face``は無視します（もうちょっと編集をしないと出て来ないはずです）。

# フェイス

```
topologydb=# SELECT * FROM topo1.face ORDER BY face_id;
 face_id |                                                                                                mbr           
---------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
       0 |
       1 | 0103000020110F00000100000005000000000000803BA46D410000000052395041000000803BA46D41000000004C3A504100000080B8A46D41000000004C3A504100000080B8A46D410000000052395041000000803BA46D410000000052395041
(2 行)
```

``mbr``というカラムがあり、EWKBとおぼしきものが出ていますが、MBR は Minimum Bounding Rectangle の略で、ポリゴンをカバーする最小の長方形を指します。基本的にはフェイスを形成するポリゴンとは同じになりません。この例ではポリゴンと同じになりますが、これはたまたまです。

EWKTにしてみると次のようになりました。

```
topologydb=# SELECT ST_AsEWKT(mbr) FROM topo1.face WHERE face_id =1;
                                                 st_asewkt
-----------------------------------------------------------------------------------------------------------
 SRID=3857;POLYGON((15540700 4253000,15540700 4254000,15541700 4254000,15541700 4253000,15540700 4253000))
(1 行)
```

# エッジ

ノードとフェイスは、かなり簡単に流しましたが、説明することが少ないからです。PostGISトポロジでは、**エッジテーブルが複雑になっています**。エッジを複雑にして、ノードとフェイスのややこしい部分を全部ここに吸収させています。
まずは、全体を見渡してみましょう。

```
topologydb=# SELECT * FROM topo1.edge ORDER BY edge_id;
 edge_id | start_node | end_node | next_left_edge | next_right_edge | left_face | right_face |                                                            geom
---------+------------+----------+----------------+-----------------+-----------+------------+----------------------------------------------------------------------------------------------------------------------------
       1 |          1 |        2 |             -3 |               2 |         0 |          1 | 0102000020110F000002000000000000803BA46D41000000004C3A504100000080B8A46D41000000004C3A5041
       2 |          1 |        3 |              3 |               1 |         1 |          0 | 0102000020110F000002000000000000803BA46D41000000004C3A5041000000803BA46D410000000052395041
       3 |          3 |        2 |             -1 |              -2 |         1 |          0 | 0102000020110F000003000000000000803BA46D41000000005239504100000080B8A46D41000000005239504100000080B8A46D41000000004C3A5041
(3 行)
```


``start_node``と``end_node``は、エッジの開始ノードと終了ノードです。

``left_face``と``right_face``は、開始ノードから終了ノードに向かって見て、それぞれ左側のフェイスと右側のフェイスです。

``next_left_edge``は、``left_face``の境界を構成するエッジの、終了ノードで接続するエッジです。負の数の場合には、自エッジと逆方向になります。``next_right_edge``も``right_face``の境界を構成するエッジの、終了ノードで接続するエッジです。

``abs_next_left_edge``と``abs_next_right_edge``は、それぞれ、``next_left_edge``と``next_right_edge``の値の符号を取り除いたものです。

``geom``は、ジオメトリです。``start_node``から``end_node``まで直線になるから不要だと思った方は、[トポロジをいじってみよう](editing)でも説明しましたが、**トポロジのノードとジオメトリのポイントとは違う**ものであることに注意して下さい。エッジは**``start_node``から``end_node``までの直線であるわけではない**のです。この例での3番エッジは2辺からなっています。ですから、ジオメトリ (ラインストリング)データは必要になります。

## next_*_edge 以外の情報を見る

まずは、``edge_id``, ``start_node``, ``end_node``, ``left_face``, ``right_face``だけを見ます。

```
topologydb=# SELECT edge_id, start_node, end_node, left_face, right_face FROM topo1.edge_data ORDER BY edge_id;
 edge_id | start_node | end_node | left_face | right_face
---------+------------+----------+-----------+------------
       1 |          1 |        2 |         0 |          1
       2 |          1 |        3 |         1 |          0
       3 |          3 |        2 |         1 |          0
(3 行)
```

1行目に注目して下さい。1番エッジ (edge_id=1)ですが、``start_node``と``end_node``から、このエッジは、1番ノードから2番ノードに向かうエッジであることが分かります。さらに、``left_face``から、このエッジの順方向から見て左側にユニバースフェイス(face_id=0のフェイス)がり、``right_face``から、右側には1番フェイスがあることが分かります。
同じく、2番エッジは1番ノードから3番ノードに向かい、左側に1番フェイス、右側にユニバースフェイスがあります。また、3番エッジは、3番ノードから2番ノードに向かい、左側に1番フェイス、右側にユニバースフェイスがあります。

## next_*_edge を見る

``next_left_edge``と``next_right_edge``を見てみます。追加で``left_face``と``right_face``も併せて見てみます。

```
topologydb=# SELECT edge_id, left_face, right_face, next_left_edge, next_right_edge FROM topo1.edge_data ORDER BY edge_id;
 edge_id | left_face | right_face | next_left_edge | next_right_edge
---------+-----------+------------+----------------+-----------------
       1 |         0 |          1 |             -3 |               2
       2 |         1 |          0 |              3 |               1
       3 |         1 |          0 |             -1 |              -2
(3 行)
```

今度は、都合のため、最初に2番エッジを見て下さい。1番エッジは最後に見ます。

2番エッジは、左側に1番フェイスがあるのは先ほど申しましたが、このことから、2番エッジは、「左側に1番フェイスを見る境界」を形成するエッジ列の一つであることが言えます。

「左側に1番フェイスを見る境界」とはまた長ったらしい名前ですが、エッジ列の順番通りに見ていくと、常に進行方向左側に1番フェイスを見るような境界となるエッジ列を指しています。

左側に同一フェイス(ここでは1番フェイス)を見る境界を形成するエッジ列の、次のエッジを示すのが``next_left_edge``です。2番エッジの``next_left_edge``が3なので、左側に1番フェイスを見る境界を形成するエッジ列のうち、2番エッジの次は3番エッジです。エッジ列のどこに2番エッジが出現するかは決まっていませんが、2番エッジの次は3番エッジ、という相対的な順番は決まっています。

ここで、せっかくなので、左側に1番フェイスを見る境界を形成するエッジ列を辿ってみましょう。
2番エッジの次の3番エッジを見てみましょう。2番エッジと同じで、1番フェイスは、3番エッジの左側にあります。3番エッジの次は、``-1``となっています。これは、１番フェイスの境界としては、3番エッジから1番エッジにつながっているけれども、逆方向 (終了ノードから開始ノードに向かう)になっていることを示します。
1番エッジを見ると、さきほど言及した通り逆になっているので、右側に1番フェイスが現れます。なので次のエッジを見るには、``next_right_edge``を見ます。``next_right_edge``は``2``となっているので、2番エッジにつながり、これで境界エッジ列が閉じました。

まとめると、2番エッジ、3番エッジ、1番エッジ(逆方向)の順で、左側に1番フェイスを見る境界が形成されるのが分かります。

同じように、1番エッジの左側のユニバースフェイスを追いかけていくと、1番エッジ、3番エッジ(逆方向)、2番エッジ(逆方向)の順で左側にユニバーサルエッジを見る境界エッジ列が得られます。

## ノードの順番を見る

最後に、蛇足気味ですが、ノードの順番を見てみましょう。

```
topologydb=# SELECT edge_id, start_node, end_node, left_face, right_face, next_left_edge, next_right_edge FROM topo1.edge_data ORDER BY edge_id;
 edge_id | start_node | end_node | left_face | right_face | next_left_edge | next_right_edge
---------+------------+----------+-----------+------------+----------------+-----------------
       1 |          1 |        2 |         0 |          1 |             -3 |               2
       2 |          1 |        3 |         1 |          0 |              3 |               1
       3 |          3 |        2 |         1 |          0 |             -1 |              -2
(3 行)
```

左側に1番フェイスを見る境界は、エッジ列では、2番エッジ、3番エッジ、1番エッジ(逆方向)の順になっていますが、これをノード番号に変えてみます。2番エッジは1番ノードから3番ノード、3番エッジは3番ノードから2番ノード、1番エッジ(逆方向)は``start_node``と``end_node``をひっくり返して、2番ノードから1番ノード、となります。

まとめると、1番ノード、3番ノード、2番ノード、1番ノードの順になります。上の図で、この順番で行くと、常に1番フェイス(真ん中の四角形)は進行方向左側にあることが分かって頂けると思います。

# おわりに

ノード、エッジ、フェイスのカラムを見ていきました。そして、エッジが特にややこしくなっているので、ノードとフェイスと比べて入念に説明を加えました（読者諸子に分かりやすくなっているかと言われたら自信はありません）。

完全には理解する必要はありませんが、PostGISトポロジを理解するのには必要な情報だろうと思いますので、さっと見ていただければいいかなと思います。

# 出典

QGISの背景図に[歴史的農業環境閲覧システム](https://habs.dc.affrc.go.jp/)が提供する関東平野迅速測図を使用しました。

