---
title: "WKT/EWKTとジオメトリとの変換"
---
# はじめに

「ジオメトリタイプ一覧をながめる」では、WKTからPostGISで使用されるジオメトリ一覧を示しました。WKTはデータ交換の相互運用を意識して書式が一応標準化されています。他方、PostGIS等の地理空間データベースにおけるジオメトリのデータ形式は、それぞれの設計に負うものですので、統一されていません。相互運用性を高めるためには、WKTとジオメトリの両者が相互に変換可能である必要があります。

地理空間を扱うSQL関数の標準は ISO/IEC 13249-3 で定めれています(SQL/MM 3)。また、JISについては JIS X 3006-3が該当します。これらの規格には、WKTとジオメトリとの相互に変換するための関数群が記載されています。そのうち、PostGISで利用可能な関数について紹介します。

また、PostGIS は WKT でなく上位互換となる EWKT が使われています。これにも触れていきます。

# ジオメトリからWKT

``ST_AsText(geom)`` で、WKTを出力します。

```
db=# SELECT ST_AsText(
  ST_Intersection(
    'POLYGON((0 0, 2 0, 2 2, 0 0))'::GEOMETRY,
    'POLYGON((0 1, 2 1, 2 2, 0 2, 0 1))'::GEOMETRY
  )
);

         st_astext          
----------------------------
 POLYGON((2 2,2 1,1 1,2 2))
(1 行)
```

# WKTからジオメトリ

## とりあえずこれ知っとけばOK

* ``ST_GeomFromText(wkt [,srid])``

すべての種類のWKTをジオメトリに変換します。
SRIDは空間参照系IDを示す整数値です。ここでは、とりあえず無視します。

## 単一ジオメトリ用

次に示す関数は、対応するジオメトリタイプが限られているものです。

* ``ST_PointFromText(wkt [,srid])``
* ``ST_LineFromText(wkt [,srid])``
* ``ST_PolyFromText(wkt [,srid])``
* ``ST_BdPolyFromText(wkt, srid)``

それぞれ、ポイント、ラインストリング、ポリゴン、ポリゴンを生成します。
最後の``ST_BdPolyFromText``は、マルチラインストリングのWKTを引数に取り、マルチラインストリングを境界線としたポリゴンを生成します。WKTと生成されるジオメトリタイプが異なる点で注意が必要です。また、PostGIS独自の問題として、sridを必ず取る必要があります。SRIDを指定したくない場合には、0を指定します。

## マルチ系ジオメトリ用

* ``ST_MPointFromText(wkt [,srid])``
* ``ST_MLineFromText(wkt [,srid])``
* ``ST_MPolyFromText(wkt [,srid])``
* ``ST_BdMPolyFromText(wkt, srid)``

それぞれ、マルチポイント、マルチラインストリング、マルチポリゴン、マルチポリゴンを生成します。
最後の``ST_BdMPolyFromText``は、前述の``ST_BdPolyFromText``と同じで、マルチラインストリングのWKTを引数に取り、マルチラインストリングを境界線としたポリゴンを生成します。SRIDを指定したくない場合には、0を指定します。

ただし、キャストを受け付けます（後述）ので、覚える必要はありません。

# EWKTとはWKT+SRID情報

冒頭触れた通り、PostGISは、WKTでなく、EWKT (Extended WKT)が使われます。EWKTはPostGIS独自の仕様で、OGC WKTとは上位互換となっています。

WKTにSRID（「空間参照系の概要」をご参照下さい）は付いていませんが、EWKTでは、先頭に``SRID=(数字);POINT(...)``といったふうに、WKTの前に``SRID``を指定して、``;``で区切ることで、そのジオメトリのSRIDが指定できます。

OGC標準である``ST_GeomFromText()``を使う場合は、関数の第2引数に``SRID``を指定できるので問題ありませんが、PostGIS独自のキャストによる変換では、文字列に何としても``SRID``を埋め込む必要があったため、このような書式が生まれたのだと思います。

他にも、ほんの少し違うところがあります。WKTが2次元座標にしか対応していない時に、EWKTはタイプ名に座標次元を組み合わせることで3次元座標、4次元座標に対応できるように拡張しましたが、この際、``POINTZ``とか``POINTM``等としました。現在のWKTは3次元、4次元に対応しているのですが、``POINT Z``等とタイプ名と座標次元とに空白を入れます。このように、ほんの少しの違いがあります。

まとめると、現在では、EWKTはWKTにSRID情報を追加できるもの、ととらえてください。

# ジオメトリからEWKTへの変換

``ST_AsEWKT(geom)`` で、WKTを出力します。

```
db=# SELECT ST_AsEWKT(
  ST_Intersection(
    'SRID=3857;POLYGON((0 0, 2 0, 2 2, 0 0))'::GEOMETRY,
    'SRID=3857;POLYGON((0 1, 2 1, 2 2, 0 2, 0 1))'::GEOMETRY
  )
);

              st_asewkt               
--------------------------------------
 SRID=3857;POLYGON((2 2,2 1,1 1,2 2))
(1 行)
```

# EWKTからジオメトリへの変換

``ST_GeomFromEWKT(text)``で変換するか、キャストを使います。関数については、``ST_...FromText``をタイプ別に用意していません。SQL/MMから外れるのですが、EWKT自体が外れているものなので、気にしないようにします。

```
db=# SELECT ST_GeomFromEWKT('SRID=4326;POINT(135 35)');
                  st_geomfromewkt                   
----------------------------------------------------
 0101000020E61000000000000000E060400000000000804140
(1 行)

db=# SELECT 'SRID=4326;POINT(135 35)'::GEOMETRY;
                      geometry                      
----------------------------------------------------
 0101000020E61000000000000000E060400000000000804140
(1 行)
```

# PostGISではWKT/EWKTからジオメトリの変換はキャストでOK

ここまででもしれっと``'POLYGON((0 0, 2 0, 2 2, 0 0))'::GEOMETRY``とか記述していたりしたのですが、WKT/EWKT文字列からGEOMETRY型にキャストすることでジオメトリの生成が可能です。``'SRID=3857;POLYGON((0 0, 2 0, 2 2, 0 0))'::GEOMETRY``も可能です。

上記の``ST_GeomFromText(text[, integer])``も``ST_GeomFromEWKT(text)``も使う必要はありません。

キャストだと互換性が失われますが、ダンプ形式では関数は使えないけれどもキャストは使えるので、ダンプ形式ではWKT/EWKTが使えて、ストアのスピードが非常に速くなります。

# おわりに

WKTからジオメトリに、ジオメトリからWKTに、それぞれ変換する関数を紹介し、WKTからジオメトリの変換はキャストで済むことを示しました。

また、SRID情報が付加されたWKTのEWKTについて紹介して、同様に関数及びキャストについて説明しました。

少なくとも、ここでご紹介したことを応用することで、簡単なジオメトリデータを自作して、クエリの``WHERE``条件の値に使ったりできるので、ある程度作れるようになった方といいです。

さらに、ダンプ形式ではキャストによる変換が可能であることも紹介しました。ただし、実際のダンプではWKB/EWKBの方が圧倒的に多いです。
