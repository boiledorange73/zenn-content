---
title: "空間インデックスを作る"
---
# はじめに

PostgreSQLに限らず、RDBMSを利用している方なら、検索条件等に利用されるカラムにはインデックスを作り、``WHERE``節等を伴うクエリ等で速度向上を図ることは、ごく普通に行われているものと思います。

ただし、PostGISユーザでない方だと、インデックスを作るカラムは数値型や文字列型等であって、ジオメトリ/ジオグラフィカラムにインデックスは作れないと思われるかも知れません。

ジオメトリ/ジオグラフィカラムに、インデックスは作れます。

# GiSTインデックス

ジオメトリ/ジオグラフィに対して R木 を生成するインデックスです。

```
CREATE INDEX [インデックス名] ON [テーブル名] USING GIST ( [ジオメトリカラム名] ); 
```
(``インデックス名``は省略可能です)

数値や文字列のカラムに対するインデックスの生成とのクエリ上の相違点は、空間インデックスには``USING GiST``と付くことだけです。

GiSTインデックスは、MBR (Minimum Bounding Rectangle) ベースで構築されます。複雑なジオメトリ形状であっても、インデックスでは全て長方形を使います。

よって、インデックス単独では、ジオメトリ演算はできません。あくまで絞り込むためのものです。

# SP-GiSTインデックス

4分木、kd 木、基数木 (トライ木) のような部分木探索に対応する一般的なインデックス手法です。
…あまり深く考えずに、GiSTではインデックスの矩形がオーバーラップするようになっていますが、SP-GiSTではオーバーラップしないようになっています。
……もっと深く考えずに、SP-GiSTは、範囲の重複が少ないような場合には、非常に高速になります。

```
CREATE INDEX [インデックス名] ON [テーブル名] USING SPGiST ( [ジオメトリカラム名] ); 
```
(``インデックス名``は省略可能です)

# インデックスの使い方

古いバージョンでは演算子``&&``が必要だったのですが、今はそんなことはありません。基本的には、ユーザが特に考えなくてもクエリプランナが勝手にインデックスを使ってくれます。

# どちらを選ぶといい？

とりあえずは GiST でいいと思います。もっとスピードが欲しくなったりした時に SP-GiST にするといいでしょう。

# おわりに

ジオメトリ/ジオグラフィカラムに対してインデックスを作ることができ、種類として GiST と SP-GiST があることを紹介しました。

また、基本的には GiST でよくて、スピードが欲しい場合には SP-GiST を検討するといいとも書きました。

いずれを採用するにしても、インデックスは適正に作るべきで、そうしないとメチャクチャ実行速度が遅くなります。
