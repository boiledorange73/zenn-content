---
title: "ST_Transform(geom, 900913)がうまくいかない"
emoji: "😀"
type: "tech"
topics: [PostGIS,GIS]
published: true
---

# はじめに

Webメルカトルの空間参照系IDは "EPSG:3857" です。が、その前には非公式に "EPSG:900913" となっていました。

ちなみに、900913 は、Google Maps で使用された座標系なので、"google" を "g"→9、"o"→0、"l"→1、"e"(ε)→3 と変換してこうなったようです。シャレですね。

この EPSG:900913 は結構問題があったように記憶していました。10年ほど前に ``900913`` に変換しようとするとおかしくなってた記憶があります。

EPSG:3857 (こちらはおかしくありません) という公式の空間参照系IDがあるので、いまさら EPSG:900913 を使うこともないと思いますが、ふと今でもおかしいのかな? と気になったので変換してみました。

```
db=# SELECT ST_AsEWKT(ST_Transform('SRID=6668;POINT(135 35)'::GEOMETRY,3857));
                       st_asewkt
-------------------------------------------------------
 SRID=3857;POINT(15028131.257091932 4163881.144064293)
(1 行)


db=# SELECT ST_AsEWKT(ST_Transform('SRID=6668;POINT(135 35)'::GEOMETRY,900913));
                        st_asewkt
---------------------------------------------------------
 SRID=900913;POINT(15028131.257091932 4139363.797427284)
(1 行)
```

今もおかしいみたいですね。

``3857``の結果 (西脇市、日本へそ公園) と ``900913``の結果 (三木市) とが大幅に異なります。Y値が24,000の差 (約20kmの差)となると全く違う投影法です。なぜこんなことになるのかを見てみようと思い立ちました。

なお、ここでは ``3857`` への変換で得られた座標値 ``(15028131.257091932 4163881.144064293)`` を「正解」とします。

## 約20kmの差について

``900913``の結果を``3857``上にそのまま置いてジオグラフィーにして計算しました。

```
SELECT ST_Distance(
  ST_Transform('SRID=3857;POINT(15028131.257091932 4163881.144064293)'::GEOMETRY, 6668)::GEOGRAPHY,
  ST_Transform('SRID=3857;POINT(15028131.257091932 4139363.797427284)'::GEOMETRY, 6668)::GEOGRAPHY
);

  st_distance
----------------
 20036.82270061
(1 行)
```

## 余談: 3395とも違う

あと ``900913`` が何かの拍子に ``3395`` になってる可能性がないこともないと思ったので、見てみました。
	
```
db=# SELECT ST_AsEWKT(ST_Transform('SRID=6668;POINT(135 35)'::GEOMETRY,3395));
                       st_asewkt
--------------------------------------------------------
 SRID=3395;POINT(15028131.257091932 4139372.7622473035)
(1 行)
```

やはり ``3395`` とも合いませんね。

# EPSG:3785 を見てみる

本当はもっとごにょごにょしてたのですが、しばらくしてから、``3785`` と ``900913``とがほぼ同じ設定になっていることが分かりました。後で出てきますが、``900913``の``srtext`` の AUTHORITY は ``3785`` です。ということは``3785``に変換すると``900913``と同じ座標値になるはずです。

ということで不正解が出れば正解ですね (ややこしい)。

## EPSG:3895 とは

私も経緯はよく分かりませんが、EPSG:3785 は、Webメルカトルの空間参照系として登録されましたが廃止されています。

## 3785との結果の違いを見る

```
db=# SELECT ST_AsEWKT(ST_Transform('SRID=6668;POINT(135 35)'::GEOMETRY,3785));
                       st_asewkt
-------------------------------------------------------
 SRID=3785;POINT(15028131.257091932 4163881.144064293)
(1 行)
```

なんで「正解」 (``3857``と同じ) になるの…。

## 3785との設定上の違いを見る

``ST_Transform()``は``spatial_ref_sys``テーブルを見ます。ということはデータを見比べれば分かるはずです。

```
db=# SELECT * FROM spatial_ref_sys WHERE srid=3785;
 srid | auth_name | auth_srid |                                                                                                                                                                                                                                                                                                                                                                                                srtext                                                                                                                                                                                                                                                                                                                                                                                                |                                                        proj4text
------+-----------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------
 3785 | EPSG      |      3785 | PROJCS["Popular Visualisation CRS / Mercator (deprecated)",GEOGCS["Popular Visualisation CRS",DATUM["Popular_Visualisation_Datum",SPHEROID["Popular Visualisation Sphere",6378137,0,AUTHORITY["EPSG","7059"]],TOWGS84[0,0,0,0,0,0,0],AUTHORITY["EPSG","6055"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4055"]],PROJECTION["Mercator_1SP"],PARAMETER["central_meridian",0],PARAMETER["scale_factor",1],PARAMETER["false_easting",0],PARAMETER["false_northing",0],UNIT["metre",1,AUTHORITY["EPSG","9001"]],AXIS["X",EAST],AXIS["Y",NORTH],EXTENSION["PROJ4","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs"],AUTHORITY["EPSG","3785"]] | +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs
(1 行)

db=# SELECT * FROM spatial_ref_sys WHERE srid=900913;
  srid  |       auth_name        | auth_srid |                                                                                                                                                                                                                                                                                                                         srtext                                                                                                                                                                                                                                                                                                                          |                                                    proj4text
--------+------------------------+-----------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------------------------------------
 900913 | spatialreferencing.org |    900913 | PROJCS["Popular Visualisation CRS / Mercator (deprecated)",GEOGCS["Popular Visualisation CRS",DATUM["Popular_Visualisation_Datum",SPHEROID["Popular Visualisation Sphere",6378137,0,AUTHORITY["EPSG","7059"]],TOWGS84[0,0,0,0,0,0,0],AUTHORITY["EPSG","6055"]],PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.01745329251994328,AUTHORITY["EPSG","9122"]],AUTHORITY["EPSG","4055"]],UNIT["metre",1,AUTHORITY["EPSG","9001"]],PROJECTION["Mercator_1SP"],PARAMETER["central_meridian",0],PARAMETER["scale_factor",1],PARAMETER["false_easting",0],PARAMETER["false_northing",0],AUTHORITY["EPSG","3785"],AXIS["X",EAST],AXIS["Y",NORTH]] | +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs
(1 行)
```

## proj4text は見てないっぽい

まずは ``proj4text`` がおかしいのか確かめました。PROJ の``cs2cs``を使います。

``900913``の``proj4text`` を使って変換をしてみます。

```
% cs2cs +init=epsg:6668 +to +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs
135 35
15028131.26     4163881.14 0.00
```

「正解」ですね。

## srtext が少し違った。

``srtext``は、少し違っていました。

``3785``は次の通りです (改行は筆者)。

```
PROJCS["Popular Visualisation CRS / Mercator (deprecated)",
  GEOGCS["Popular Visualisation CRS",
    DATUM["Popular_Visualisation_Datum",
      SPHEROID["Popular Visualisation Sphere",6378137,0,AUTHORITY["EPSG","7059"]],
      TOWGS84[0,0,0,0,0,0,0],
      AUTHORITY["EPSG","6055"]
    ],
    PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],
    UNIT["degree",0.0174532925199433,AUTHORITY["EPSG","9122"]],
    AUTHORITY["EPSG","4055"]
  ],
  PROJECTION["Mercator_1SP"],
  PARAMETER["central_meridian",0],
  PARAMETER["scale_factor",1],
  PARAMETER["false_easting",0],
  PARAMETER["false_northing",0],
  UNIT["metre",1,AUTHORITY["EPSG","9001"]],
  AXIS["X",EAST],
  AXIS["Y",NORTH],
  EXTENSION["PROJ4","+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext +no_defs"],
  AUTHORITY["EPSG","3785"]
]
```

``900913``は次の通りです (改行は筆者)。

```
PROJCS["Popular Visualisation CRS / Mercator (deprecated)",
  GEOGCS["Popular Visualisation CRS",
    DATUM["Popular_Visualisation_Datum",
      SPHEROID["Popular Visualisation Sphere",6378137,0,AUTHORITY["EPSG","7059"]],
      TOWGS84[0,0,0,0,0,0,0],
      AUTHORITY["EPSG","6055"]
    ],
    PRIMEM["Greenwich",0,AUTHORITY["EPSG","8901"]],
    UNIT["degree",0.01745329251994328,AUTHORITY["EPSG","9122"]],
    AUTHORITY["EPSG","4055"]
  ],
  UNIT["metre",1,AUTHORITY["EPSG","9001"]],
  PROJECTION["Mercator_1SP"],
  PARAMETER["central_meridian",0],
  PARAMETER["scale_factor",1],
  PARAMETER["false_easting",0],
  PARAMETER["false_northing",0],
  AUTHORITY["EPSG","3785"],
  AXIS["X",EAST],
  AXIS["Y",NORTH]
]
```

順序が若干違いますが、ほとんど同じです。ただ 900913 には ``EXTENSION`` がありません。

## srtext を 完全にあわせると「正解」になった

``900913`` の ``srtext`` を ``3785`` に合わせたうえで変換してみます。

```
% createdb test900913
% psql -d test900913
test900913 =# CREATE EXTENSION postgis;
CREATE EXTENSION
test900913 =# UPDATE spatial_ref_sys
  SET srtext=(SELECT srtext FROM spatial_ref_sys WHERE srid=3785)
  WHERE srid=900913;
test900913=# SELECT ST_AsEWKT(ST_Transform('SRID=6668;POINT(135 35)'::GEOMETRY,900913));
                        st_asewkt
---------------------------------------------------------
 SRID=900913;POINT(15028131.257091932 4163881.144064293)
(1 行)
```

「正解」にたどり着きました。


# おわりに

まず大前提として、deprecated になってる以上、``900913`` はもはや不要なものであって、``3857`` を使うようにクエリなどを置き換えてしまうべきだと思います。

この記事は、なんで ``900913`` への変換がおかしいかを調べた結果です。

``ST_Transform()`` は ``proj4text`` でなく ``srtext`` を見てるけど、``EXTENSION["PROJ4"...]`` があるとそちらを見てるっぽいようです。ソースを全く追いかけていませんが…。

よって ``900913``を「正解」にするには ``900913`` の ``srtext`` を ``3785`` のものを複写すればいいみたいです。

我ながら歯切れ悪いな…。
